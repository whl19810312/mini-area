import React, { useState, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import { useAuth } from '../contexts/AuthContext'
import { useMetaverse } from '../contexts/MetaverseContext'
import axios from 'axios'
import toast from 'react-hot-toast'
import '../styles/Sidebar.css'

const Sidebar = ({ 
  open, 
  onClose, 
  maps: mapsProps, 
  currentMap: currentMapProps, 
  onMapSelect
}) => {
  const navigate = useNavigate()
  const { user } = useAuth()
  const { 
    maps: contextMaps, 
    currentMap: contextCurrentMap, 
    fetchMyMaps, 
    fetchMaps,
    selectMap,
    debugMaps,
    forceRefreshMaps,
    mapParticipants,
    serverMapsList,
    allUsersInfo,
    createMap
  } = useMetaverse()
  
  // propsÍ∞Ä ÏûàÏúºÎ©¥ props ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ ÏÑúÎ≤Ñ Î™©Î°ù ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ context ÏÇ¨Ïö©
  const maps = mapsProps || serverMapsList || contextMaps
  const currentMap = currentMapProps || contextCurrentMap
  const [isHovered, setIsHovered] = useState(false)
  const [collapsedSections, setCollapsedSections] = useState({
    create: false,
    myMaps: false,
    publicMaps: false
  })
  const [editingMapId, setEditingMapId] = useState(null)
  const [editingMapName, setEditingMapName] = useState('')
  const [tempMaps, setTempMaps] = useState([])

  // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  useEffect(() => {
    fetchMyMaps()
  }, [fetchMyMaps])

  const handleMapSelect = (map) => {
    if (onMapSelect) {
      onMapSelect(map)
    } else {
      selectMap(map)
      // URL ÏóÖÎç∞Ïù¥Ìä∏
      navigate(`/metaverse/${map.id || map._id}`)
    }
  }

  // ÏûÖÏû• Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Îßµ ÏÑ†ÌÉù
  const handleEnterMap = (map) => {
    console.log('üéØ ÏûÖÏû• Î≤ÑÌäº ÌÅ¥Î¶≠:', {
      mapId: map.id || map._id,
      mapName: map.name
    })
    
    // Îßµ ÏÑ†ÌÉù
    selectMap(map)
    
    // URL ÏóÖÎç∞Ïù¥Ìä∏
    navigate(`/metaverse/${map.id || map._id}`)
  }

  const handleCreateMap = async () => {
    const roomName = prompt('ÏÉà Î∞© Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:')
    if (!roomName || roomName.trim() === '') {
      return
    }
    
    try {
      const newMap = await createMap({
        name: roomName.trim(),
        createdBy: user?.id || user?.username
      })
      
      if (newMap && newMap.id) {
        navigate(`/metaverse/edit/${newMap.id}`)
      }
    } catch (error) {
      console.error('Î∞© ÏÉùÏÑ± Ïã§Ìå®:', error)
      alert('Î∞© ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
    }
  }

  const handleEditMap = (map) => {
    console.log('‚úèÔ∏è Editing room:', map)
    navigate(`/metaverse/edit/${map.id || map._id}`, { 
      state: { 
        map,
        isEdit: true
      }
    })
  }

  const handleDeleteMap = async (map) => {
    // Îçî ÏïàÏ†ÑÌïú ÌôïÏù∏ Îã§Ïù¥ÏñºÎ°úÍ∑∏
    const isConfirmed = window.confirm(
      `Ï†ïÎßêÎ°ú "${map.name}" Í∞ÄÏÉÅÍ≥µÍ∞ÑÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n` +
      `‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.\n` +
      `‚Ä¢ Í∞ÄÏÉÅÍ≥µÍ∞ÑÏùò Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÎê©ÎãàÎã§.\n` +
      `‚Ä¢ ÌòÑÏû¨ ÏûÖÏû• Ï§ëÏù∏ ÏÇ¨Ïö©ÏûêÎì§Ïù¥ Í∞ïÏ†úÎ°ú ÎÇòÍ∞ÄÍ≤å Îê©ÎãàÎã§.\n\n` +
      `ÏÇ≠Ï†úÌïòÎ†§Î©¥ "ÌôïÏù∏"ÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.`
    )
    
    if (!isConfirmed) {
      return
    }

    try {
      console.log('üóëÔ∏è Í∞ÄÏÉÅÍ≥µÍ∞Ñ ÏÇ≠Ï†ú ÏãúÎèÑ:', map.name, map.id || map._id)
      
      const response = await axios.delete(`/api/maps/${map.id || map._id}`)
      
      if (response.status === 200) {
        toast.success(`"${map.name}" Í∞ÄÏÉÅÍ≥µÍ∞ÑÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`)
        
        // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        fetchMyMaps()
        forceRefreshMaps()
        
        console.log('‚úÖ Í∞ÄÏÉÅÍ≥µÍ∞Ñ ÏÇ≠Ï†ú ÏôÑÎ£å:', map.name)
      }
    } catch (error) {
      console.error('‚ùå Í∞ÄÏÉÅÍ≥µÍ∞Ñ ÏÇ≠Ï†ú Ïã§Ìå®:', error)
      
      if (error.response?.status === 403) {
        toast.error('ÏÇ≠Ï†ú Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§. Î≥∏Ïù∏Ïù¥ ÎßåÎì† Í∞ÄÏÉÅÍ≥µÍ∞ÑÎßå ÏÇ≠Ï†úÌï† Ïàò ÏûàÏäµÎãàÎã§.')
      } else if (error.response?.status === 404) {
        toast.error('Í∞ÄÏÉÅÍ≥µÍ∞ÑÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.')
      } else {
        toast.error('Í∞ÄÏÉÅÍ≥µÍ∞Ñ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.')
      }
    }
  }

  const handleDeleteTempMap = (tempMap) => {
    if (!window.confirm(`Are you sure you want to delete the temporary room \"${tempMap.name}\"?`)) {
      return
    }
    
    setTempMaps(prev => prev.filter(tm => tm.id !== tempMap.id))
    toast.success('Temporary room deleted successfully.')
  }

  const handleEditName = (map) => {
    setEditingMapId(map.id || map._id)
    setEditingMapName(map.name)
  }

  const handleSaveName = async (map) => {
    try {
      const response = await axios.put(`/api/maps/${map.id || map._id}`, {
        name: editingMapName
      })
      
      if (response.status === 200) {
        toast.success('Room name changed successfully.')
        fetchMyMaps()
        setEditingMapId(null)
        setEditingMapName('')
      }
    } catch (error) {
      console.error('Failed to change room name:', error)
      toast.error('Failed to change room name.')
    }
  }

  const handleCancelEdit = () => {
    setEditingMapId(null)
    setEditingMapName('')
  }

  const toggleSection = (section) => {
    setCollapsedSections(prev => ({
      ...prev,
      [section]: !prev[section]
    }))
  }

  // Separate my rooms and public rooms
  const myMaps = maps.filter(map => map.createdBy === user?.id)
  const publicMaps = maps.filter(map => map.isPublic && map.createdBy !== user?.id)

  return (
    <>
      {/* Ïò§Î≤ÑÎ†àÏù¥ */}
      {open && (
        <div 
          className="sidebar-overlay" 
          onClick={onClose}
        />
      )}

      {/* ÏÇ¨Ïù¥ÎìúÎ∞î */}
      <div 
        className={`sidebar ${open ? 'open' : ''} ${isHovered ? 'hovered' : ''}`}
        onMouseEnter={() => setIsHovered(true)}
        onMouseLeave={() => {
          if (!open) {
            setIsHovered(false)
          }
        }}
      >
        <div className="sidebar-header">
          <h2>Rooms</h2>
          <button onClick={onClose} className="close-btn">√ó</button>
        </div>

        <div className="sidebar-content">
          <div className="tab-content">
            <p>You can create or enter a room.</p>
            
            {/* Create a new room */}
            <div className="create-section">
              <div className="section-header-with-toggle">
                <h4>Create a New Room</h4>
                <button 
                  className="toggle-btn"
                  onClick={() => toggleSection('create')}
                  title={collapsedSections.create ? 'ÌéºÏπòÍ∏∞' : 'Ï†ëÍ∏∞'}
                >
                  {collapsedSections.create ? '‚ñº' : '‚ñ≤'}
                </button>
              </div>
              {!collapsedSections.create && (
                <div className="section-content">
                  <button 
                    onClick={handleCreateMap}
                    className="create-btn primary"
                  >
                    üé® Create a New Room
                  </button>
                  
                  {tempMaps.length > 0 && (
                    <div className="temp-maps-section">
                      <h5>Temporary Rooms ({tempMaps.length})</h5>
                      <div className="map-list">
                        {tempMaps.map((tempMap) => (
                          <div 
                            key={`temp-map-${tempMap.id}`} 
                            className="map-item temp-map-item"
                          >
                            <div 
                              className="map-content"
                              onClick={() => handleMapSelect(tempMap)}
                              style={{ cursor: 'pointer' }}
                            >
                              <div className="map-thumbnail">
                                <div className="map-thumbnail-placeholder">
                                  üé®
                                </div>
                              </div>
                              <div className="map-info">
                                <h4 className="temp-map-name">{tempMap.name}</h4>
                                <p>Temporary Room</p>
                                <p>ÌÅ¨Í∏∞: {tempMap.size?.width} x {tempMap.size?.height}</p>
                              </div>
                            </div>
                            <div className="map-actions" onClick={(e) => e.stopPropagation()}>
                              <button 
                                onClick={() => handleEnterMap(tempMap)}
                                className="enter-btn"
                                title="Enter Room"
                              >
                                ÏûÖÏû•
                              </button>
                              <button 
                                onClick={() => handleEditMap(tempMap)}
                                className="edit-btn"
                                title="Edit Room"
                              >
                                Ìé∏Ïßë
                              </button>
                              <button 
                                onClick={() => handleDeleteTempMap(tempMap)}
                                className="delete-btn"
                                title="Delete Temporary Room"
                              >
                                ÏÇ≠Ï†ú
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* My Rooms */}
            <div className="my-maps-section">
              <div className="section-header-with-toggle">
                <h4>My Rooms ({myMaps.length})</h4>
                <button 
                  className="toggle-btn"
                  onClick={() => toggleSection('myMaps')}
                  title={collapsedSections.myMaps ? 'ÌéºÏπòÍ∏∞' : 'Ï†ëÍ∏∞'}
                >
                  {collapsedSections.myMaps ? '‚ñº' : '‚ñ≤'}
                </button>
              </div>
              {!collapsedSections.myMaps && (
                <div className="section-content">
                  {myMaps.length === 0 ? (
                    <div className="empty-maps-container">
                      <p>You don't have any rooms.</p>
                      <button 
                        onClick={handleCreateMap}
                        className="create-btn secondary"
                      >
                        üé® Create your first room
                      </button>
                    </div>
                  ) : (
                    <div className="map-list">
                      {myMaps.map((map) => (
                        <div 
                          key={`my-map-${map.id || map._id}`} 
                          className={`map-item ${currentMap && (currentMap.id || currentMap._id) === (map.id || map._id) ? 'current' : ''}`}
                        >
                          <div 
                            className="map-content"
                            onClick={() => handleMapSelect(map)}
                            style={{ cursor: 'pointer' }}
                          >
                            <div className="map-thumbnail">
                              {map.backgroundLayer?.image?.data ? (
                                <img 
                                  src={`data:${map.backgroundLayer.image.contentType};base64,${map.backgroundLayer.image.data}`}
                                  alt={map.name}
                                  className="map-thumbnail-image"
                                />
                              ) : (
                                <div className="map-thumbnail-placeholder">
                                  üé®
                                </div>
                              )}
                            </div>
                            <div className="map-info">
                              {editingMapId === (map.id || map._id) ? (
                                <div className="name-edit-container">
                                  <input
                                    type="text"
                                    value={editingMapName}
                                    onChange={(e) => setEditingMapName(e.target.value)}
                                    onKeyPress={(e) => {
                                      if (e.key === 'Enter') {
                                        handleSaveName(map)
                                      } else if (e.key === 'Escape') {
                                        handleCancelEdit()
                                      }
                                    }}
                                    className="name-edit-input"
                                    autoFocus
                                  />
                                  <div className="name-edit-buttons">
                                    <button 
                                      onClick={() => handleSaveName(map)}
                                      className="save-name-btn"
                                      title="Ï†ÄÏû•"
                                    >
                                      ‚úì
                                    </button>
                                    <button 
                                      onClick={handleCancelEdit}
                                      className="cancel-name-btn"
                                      title="Ï∑®ÏÜå"
                                    >
                                      ‚úï
                                    </button>
                                  </div>
                                </div>
                              ) : (
                                <h4 
                                  onClick={() => map.createdBy === user?.id && handleEditName(map)}
                                  className={`map-name-editable ${map.createdBy === user?.id ? 'editable' : ''}`}
                                  title={map.createdBy === user?.id ? 'ÌÅ¥Î¶≠ÌïòÏó¨ Ïù¥Î¶Ñ Î≥ÄÍ≤Ω' : ''}
                                >
                                  {map.name} {map.createdBy === user?.id && '‚úèÔ∏è'}
                                </h4>
                              )}
                              <p>{map.description}</p>
                              <p>ÌÅ¨Í∏∞: {map.size?.width} x {map.size?.height}</p>
                              <p className="creator-info">üë§ Ï†úÏûëÏûê: {map.creator?.username || 'Ïïå Ïàò ÏóÜÏùå'}</p>
                              <p className="participants-info">
                                üë• ÏûÖÏã§ Ïù∏Ïõê: {allUsersInfo?.mapParticipantCounts?.[map.id || map._id] || 0}Î™Ö
                              </p>
                              {map.publicLink && (
                                <p className="public-link">
                                  üîó Í≥µÍ∞ú ÎßÅÌÅ¨: {map.publicLink}
                                </p>
                              )}
                            </div>
                          </div>
                          <div className="map-actions" onClick={(e) => e.stopPropagation()}>
                            <button 
                              onClick={() => handleEnterMap(map)}
                              className="enter-btn"
                              title="Enter Room"
                            >
                              ÏûÖÏû•
                            </button>
                            {map.createdBy === user?.id && (
                              <button 
                                onClick={() => handleEditMap(map)}
                                className="edit-btn"
                                title="Edit Room"
                              >
                                Ìé∏Ïßë
                              </button>
                            )}
                            {map.createdBy === user?.id && (
                              <button 
                                onClick={() => handleDeleteMap(map)}
                                className="delete-btn"
                                title="Delete Room"
                              >
                                ÏÇ≠Ï†ú
                              </button>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Public Rooms */}
            <div className="public-section">
              <div className="section-header-with-toggle">
                <h4>Room List ({publicMaps.length})</h4>
                <button 
                  className="toggle-btn"
                  onClick={() => toggleSection('publicMaps')}
                  title={collapsedSections.publicMaps ? 'ÌéºÏπòÍ∏∞' : 'Ï†ëÍ∏∞'}
                >
                  {collapsedSections.publicMaps ? '‚ñº' : '‚ñ≤'}
                </button>
              </div>
              {!collapsedSections.publicMaps && (
                <div className="section-content">
                  {publicMaps.length === 0 ? (
                    <div className="empty-maps-container">
                      <p>There are no public rooms.</p>
                      <div className="refresh-actions">
                        <button 
                          onClick={() => {
                            console.log('üîÑ Attempting to refresh room list')
                            debugMaps()
                            forceRefreshMaps()
                          }}
                          className="refresh-btn"
                          title="Refresh Room List"
                        >
                          üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                        </button>
                        <button 
                          onClick={() => {
                            console.log('üîç Printing room list debug info')
                            debugMaps()
                          }}
                          className="debug-btn"
                          title="ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ Ï∂úÎ†•"
                        >
                          üîç ÎîîÎ≤ÑÍ∑∏
                        </button>
                      </div>
                    </div>
                  ) : (
                    <div className="map-list">
                      {publicMaps.map((map) => (
                        <div 
                          key={`public-map-${map.id || map._id}`} 
                          className={`map-item ${currentMap && (currentMap.id || currentMap._id) === (map.id || map._id) ? 'current' : ''}`}
                        >
                          <div 
                            className="map-content"
                            onClick={() => handleMapSelect(map)}
                            style={{ cursor: 'pointer' }}
                          >
                            <div className="map-thumbnail">
                              {map.backgroundLayer?.image?.data ? (
                                <img 
                                  src={`data:${map.backgroundLayer.image.contentType};base64,${map.backgroundLayer.image.data}`}
                                  alt={map.name}
                                  className="map-thumbnail-image"
                                />
                              ) : (
                                <div className="map-thumbnail-placeholder">
                                  üé®
                                </div>
                              )}
                            </div>
                            <div className="map-info">
                              <h4>{map.name}</h4>
                              <p>{map.description}</p>
                              <p>ÌÅ¨Í∏∞: {map.size?.width} x {map.size?.height}</p>
                              <p className="creator-info">üë§ Ï†úÏûëÏûê: {map.creator?.username || 'Ïïå Ïàò ÏóÜÏùå'}</p>
                              <p className="participants-info">
                                üë• ÏûÖÏã§ Ïù∏Ïõê: {allUsersInfo?.mapParticipantCounts?.[map.id || map._id] || 0}Î™Ö
                              </p>
                              {map.publicLink && (
                                <p className="public-link">
                                  üîó Í≥µÍ∞ú ÎßÅÌÅ¨: {map.publicLink}
                                </p>
                              )}
                            </div>
                          </div>
                          <div className="map-actions" onClick={(e) => e.stopPropagation()}>
                            <button 
                              onClick={() => handleEnterMap(map)}
                              className="enter-btn"
                              title="Enter Room"
                            >
                              ÏûÖÏû•
                            </button>
                            {map.createdBy === user?.id && (
                              <button 
                                onClick={() => handleEditMap(map)}
                                className="edit-btn"
                                title="Edit Room"
                              >
                                Ìé∏Ïßë
                              </button>
                            )}
                            {map.createdBy === user?.id && (
                              <button 
                                onClick={() => handleDeleteMap(map)}
                                className="delete-btn"
                                title="Delete Room"
                              >
                                ÏÇ≠Ï†ú
                              </button>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </>
  )
}

export default Sidebar 